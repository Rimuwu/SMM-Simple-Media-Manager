"""
–ú–æ–¥—É–ª—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ –∫–∞—Ä—Ç–æ—á–∫–∞–º.

–°–æ–¥–µ—Ä–∂–∏—Ç —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ TaskScheduler.
"""

import logging
from models.Card import Card, CardStatus
from models.User import User
from global_modules.classes.enums import UserRole
from modules.api_client import executors_api
from modules.constants import ApiEndpoints
from datetime import datetime

logger = logging.getLogger(__name__)


async def send_card_deadline_reminder(card: Card, **kwargs):
    """
    –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –¥–µ–¥–ª–∞–π–Ω–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—é (–∑–∞ 2 –¥–Ω—è –¥–æ –¥–µ–¥–ª–∞–π–Ω–∞).
    –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ ready.
    
    Args:
        card: –ö–∞—Ä—Ç–æ—á–∫–∞, –ø–æ –∫–æ—Ç–æ—Ä–æ–π –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
        **kwargs: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    """
    logger.info(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –¥–µ–¥–ª–∞–π–Ω–µ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ {card.card_id}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç–æ—á–∫–∏
    if card.status == CardStatus.ready:
        logger.info(f"–ö–∞—Ä—Ç–æ—á–∫–∞ {card.card_id} –∏–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å ready, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è")
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
    if not card.executor_id:
        logger.info(f"–£ –∫–∞—Ä—Ç–æ—á–∫–∏ {card.card_id} –Ω–µ—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è")
        return
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
        executor = await User.get_by_key('user_id', card.executor_id)
        if not executor:
            logger.error(f"–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å {card.executor_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–µ–¥–ª–∞–π–Ω
        deadline_str = card.deadline.strftime('%d.%m.%Y %H:%M') if card.deadline else '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        message_text = f"‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –¥–µ–¥–ª–∞–π–Ω–µ\n\nüìù –ó–∞–¥–∞—á–∞: {card.name}\n‚è∞ –î–µ–¥–ª–∞–π–Ω: {deadline_str}\n\n–û—Å—Ç–∞–ª–æ—Å—å 2 –¥–Ω—è!"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        await executors_api.post(
            ApiEndpoints.NOTIFY_USER,
            data={
                "user_id": executor.telegram_id,
                "message": message_text
            }
        )
        
        logger.info(f"–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ {card.card_id} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—é {executor.telegram_id}")
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ {card.card_id}: {e}", exc_info=True)


async def send_admin_no_executor_alert(card: Card, **kwargs):
    """
    –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º –∞–¥–º–∏–Ω–∞–º –æ —Ç–æ–º, —á—Ç–æ —É –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è (–∑–∞ 1 –¥–µ–Ω—å –¥–æ –¥–µ–¥–ª–∞–π–Ω–∞).
    –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—Ä–µ–º—è –¥–æ –¥–µ–¥–ª–∞–π–Ω–∞ –±–æ–ª—å—à–µ 1 –¥–Ω—è –∏ –Ω–µ—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è.
    
    Args:
        card: –ö–∞—Ä—Ç–æ—á–∫–∞, –ø–æ –∫–æ—Ç–æ—Ä–æ–π –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        **kwargs: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    """
    logger.info(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ {card.card_id}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
    if card.executor_id:
        logger.info(f"–£ –∫–∞—Ä—Ç–æ—á–∫–∏ {card.card_id} –µ—Å—Ç—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è")
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥–µ–¥–ª–∞–π–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
    if not card.deadline:
        logger.info(f"–£ –∫–∞—Ä—Ç–æ—á–∫–∏ {card.card_id} –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–µ–¥–ª–∞–π–Ω")
        return
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –∞–¥–º–∏–Ω–æ–≤
        admins = await User.filter_by(role=UserRole.admin)
        if not admins:
            logger.warning("–ê–¥–º–∏–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ")
            return
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–µ–¥–ª–∞–π–Ω
        deadline_str = card.deadline.strftime('%d.%m.%Y %H:%M')
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        message_text = f"‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! –ö–∞—Ä—Ç–æ—á–∫–∞ –±–µ–∑ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è\n\nüìù –ó–∞–¥–∞—á–∞: {card.name}\n‚è∞ –î–µ–¥–ª–∞–π–Ω: {deadline_str}\n\n‚ùó –î–æ –¥–µ–¥–ª–∞–π–Ω–∞ –æ—Å—Ç–∞–ª—Å—è 1 –¥–µ–Ω—å, –Ω–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω!"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∂–¥–æ–º—É –∞–¥–º–∏–Ω—É
        for admin in admins:
            try:
                await executors_api.post(
                    ApiEndpoints.NOTIFY_USER,
                    data={
                        "user_id": admin.telegram_id,
                        "message": message_text
                    }
                )
                logger.info(f"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∫–∞—Ä—Ç–æ—á–∫–µ {card.card_id} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω—É {admin.telegram_id}")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É {admin.telegram_id}: {e}")
        
        logger.info(f"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∫–∞—Ä—Ç–æ—á–∫–µ {card.card_id} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ–º –∞–¥–º–∏–Ω–∞–º")
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∞–¥–º–∏–Ω–∞–º –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ {card.card_id}: {e}", exc_info=True)


async def send_card_notification(card: Card, message_type: str = "default", **kwargs):
    """
    –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ.
    
    Args:
        card: –ö–∞—Ä—Ç–æ—á–∫–∞
        message_type: –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ —Ç.–¥.)
        **kwargs: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    """
    logger.info(f"–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–∏–ø–∞ '{message_type}' –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ {card.card_id}")
    
    # TODO: –õ–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
    # if message_type == "deadline":
    #     await send_deadline_message(card)
    # elif message_type == "status_change":
    #     await send_status_change_message(card)
    
    logger.info(f"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ {card.card_id} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ")


async def publish_card_content(card: Card, **kwargs):
    """
    –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è.
    
    Args:
        card: –ö–∞—Ä—Ç–æ—á–∫–∞ —Å –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
        **kwargs: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    """
    logger.info(f"–ü—É–±–ª–∏–∫–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ {card.card_id}")
    
    # TODO: –õ–æ–≥–∏–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    # - –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏
    # - –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–æ–≤
    # - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞—Ä—Ç–æ—á–∫–∏
    
    logger.info(f"–ö–æ–Ω—Ç–µ–Ω—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ {card.card_id} –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω")


async def check_card_approval(card: Card, **kwargs):
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏.
    
    Args:
        card: –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        **kwargs: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    """
    logger.info(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ {card.card_id}")
    
    if card.need_check:
        # TODO: –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏
        logger.info(f"–ö–∞—Ä—Ç–æ—á–∫–∞ {card.card_id} –æ–∂–∏–¥–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏")
    
    logger.info(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ {card.card_id} –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
